= Quay Repositories
include::_attributes.adoc[]

[#imagerepo]
== Creating an image repository

* Click `Create New Repository`.

image::repositories/create-repo.png[]

* Select the organization in the drop down list, name the repository `kafka` and set `Public` visibility.

image::repositories/repo-config.png[]

* Click `Create Public Repository`.

[#push]
== Push (and tag) an image into the repository

* Pull an image from the public registry.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
podman pull quay.io/strimzi/kafka:latest-kafka-3.2.1
----

* Tag the image.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
podman tag quay.io/strimzi/kafka:latest-kafka-3.2.1 ${QUAY_HOSTNAME}/olleb/kafka:3.2.1
----

* Sign into our Quay repository (if we are not already signed in).

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
podman login ${QUAY_HOSTNAME}
----

* Push the image to Quay repository.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
podman push ${QUAY_HOSTNAME}/olleb/kafka:3.2.1
----

* Check that the image has been pushed into our Quay repository.

image::repositories/image-pushed.png[]

[#imglayers]
== Inspecting image layers

* Navigate to the `olleb/kafka` repository.

* Click the `Tags` icon.

* Click the `SHA256` value under `MANIFEST` of the `3.2.1` tag to see the layers dashboard.

image::repositories/image-pushed2.png[]

image::repositories/img-layers.png[]

[#pull]
== Pull an image from the repository

* From Quay dashboard, click the `olleb/kafka` repository.

* Click `Tags`.

* On any of the tags, click the `Fetch Tag` icon.

image::repositories/fetchtagpre.png[]

* Select `Podman Pull (by tag)` from the `Image Format` drop down and click the `Copy Command` button.

image::repositories/fetchtag.png[]

* Switch to a terminal, paste and execute the command on it. Podman is required. As we created the repository as `Public`, login is not required to pull.

[#rollback]
== Image rollback

Quay provide us a way for reviewing the history of tags and revert those to a previous image.

* Create a new image repository as already explained. I created the `olleb/rollback` public repository.

* Build an image, tag it and push it.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
echo "FROM scratch" > Containerfile.rbk
podman build . -t rollback:1.0 -f Containerfile.rbk

podman tag localhost/rollback:1.0 ${QUAY_HOSTNAME}/olleb/rollback:latest
podman push ${QUAY_HOSTNAME}/olleb/rollback:latest
----

* Verify that the image has been pushed into Quay repository. Check also the manifest digest and the layers.

image::repositories/rblatest1.png[]

image::repositories/rblayers1.png[]

* Add a new layer, build, tag it with the same remote tag and push the new image to *overwrite* the old one.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
echo "LABEL org.opencontainers.image.authors=angel@olleb.com" >> Containerfile.rbk
podman build . -t rollback:2.0 -f Containerfile.rbk

podman tag localhost/rollback:2.0 ${QUAY_HOSTNAME}/olleb/rollback:latest
podman push ${QUAY_HOSTNAME}/olleb/rollback:latest
----

* Verify that the image has been pushed into Quay repository. Check also the manifest digest and the layers. Observe that the manifest digest and the layers are different than the previous image.

image::repositories/rblatest2.png[]

image::repositories/rblayers2.png[]

* Rollback the image to the previous one. Click `Tag History`.

image::repositories/taghistory.png[]

* Click `Revert to ...`.

image::repositories/revert.png[]

* Click `Restore Tag`.

image::repositories/restoretag.png[]

* Verify that the image has been restored with the previous one.

image::repositories/restored.png[]

[#expiration]
== Image expiration

Image tags can be configured to expire from Quay on a time and date.

* Create a new image repository as already explained. I created the `olleb/expiration` repository.

* Build a `1.0` image, tag it and push it.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
echo "FROM scratch" > Containerfile.exp
podman build . -t exp:1.0 -f Containerfile.exp

podman tag localhost/exp:1.0 ${QUAY_HOSTNAME}/olleb/expiration:1.0
podman push ${QUAY_HOSTNAME}/olleb/expiration:1.0
----

* Build a new `2.0` image, tag it also as `latest` and push both tags. On that image version, we are going to include the label `quay.expires-after` with a value of `5m` in our `Containerfile`; Quay will automatically expire those tags after the indicated time.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
echo "LABEL org.opencontainers.image.authors=angel@olleb.com" >> Containerfile.exp
echo "LABEL quay.expires-after=5m" >> Containerfile.exp
podman build . -t exp:2.0 -f Containerfile.exp

podman tag localhost/exp:2.0 ${QUAY_HOSTNAME}/olleb/expiration:2.0
podman push ${QUAY_HOSTNAME}/olleb/expiration:2.0

podman tag localhost/exp:2.0 ${QUAY_HOSTNAME}/olleb/expiration:latest
podman push ${QUAY_HOSTNAME}/olleb/expiration:latest
----

* We should have two images and three tags in our repository. Two of them marked as expiring soon.

image::repositories/exp1.png[]

After a while, both tags will be removed automatically.

image::repositories/taghistoryautodeleted.png[]

* Select the `1.0` tag, in the `Actions` drop down list select `Change Tags Expiration`. Set the desired `Expiration Date`.

image::repositories/expirationdatetag.png[]

TIP: Alternatively, the expiration also can be set through the `Options` icon â†’ `Change Expiration`.

When the tag is about to expire a message is shown:

image::repositories/abouttoexpire.png[]

NOTE: by default, the minimum expiration time is one hour and the maximum is 104 weeks (2 years aprox.); at the time of this writing. If we want to allow earlier/later minimum expiration, the `LABELED_EXPIRATION_MINIMUM` property can be set to a different time value like `60s` (seconds), `5m` (minutes), `24h` (hours), `7d` (days), `2w` (weeks). The configuration has to be put in the `Config Bundle Secret` of our registry instance. An example of how to do it is explained in the following section xref:quay-oci.adoc#allowed[2.5.1 Configuring allowed OCI artifact types].

When the tag expires, is deleted automatically.

image::repositories/tagexpireddeleted.png[]

NOTE: Note that even though the tag is deleted, we can still restore the image. The reason is, when a tag is deleted, and there are no other tags pointing on the same image, the image is garbage collected not before the default value, which is 14 days (`2w`). Quay has a gc worker enabled by default which runs periodically and removes the expired stuff when the configured *Time Machine* amount of time passed.

As we stored the image inside `olleb` organization, we can check that value browsing to `/organization/olleb?tab=settings`.

image::repositories/orgexptime.png[]

If the image stored is under the user account instead on an organization, the value is under user settings.

The Time Machine amount time can be modified changing the value of `TAG_EXPIRATION_OPTIONS` array property; a default expiration value also exists which is `DEFAULT_TAG_EXPIRATION`, `TAG_EXPIRATION_OPTIONS` *must* include that value in the list. As before, an example of how to do it is explained in the following section xref:quay-oci.adoc#allowed[2.5.1 Configuring allowed OCI artifact types].

For example, with the following custom configuration:

image::repositories/expcfg.png[]

we will see:

image::repositories/customtm.png[]
