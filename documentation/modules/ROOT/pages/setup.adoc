= Prerequisites
include::_attributes.adoc[]

[NOTE,subs="attributes+,+macros"]
====
This tutorial was developed and tested with:

* Red Hat OpenShift `4.19.8`
* Red Hat Quay `3.15`
====

The following tools are required to run the exercises in this tutorial. Please ensure that they are installed and properly configured before proceeding with any of the tutorial chapters.

include::partial$tools.adoc[]

[#odf]
== ODF Operator

Install OpenShift Data Foundation Operator by following these steps:

* Open a browser window and log in to the Red Hat OpenShift Container Platform web console.

* From the *Administrator* perspective, click `Operators`, and then select `OperatorHub`.

* In the *Filter by keyword* field, type `ODF`.

image::install/operatorhub-odf.png[]

* Select the Red Hat OpenShift Data Foundation tile and click the `Install` button.

image::install/odf-install.png[]

* On the *Install Operator* page, select `stable-4.19` from the list of available *Update Channel* options, and then choose *A specific namespace on the cluster*. Leave the default value for *Installed Namespace* as `openshift-storage`, and set *Update Approval* to `Automatic`. Also, make sure to enable the console plug-in.

image::install/odfoperator-install-opts.png[]

* Click `Install`.

[#storage]
== Creating the ODF Cluster

Deploy an OpenShift Data Foundation (ODF) `StorageCluster` using the OpenShift web console.

* From the *Administrator* perspective in the OpenShift console, navigate to `Storage` > `Data Foundation`.
* Go to the *Storage System* tab.
* Click `Create StorageSystem`.

image::install/odf1.png[]

Select the backing storage type:

* On the first page of the wizard (*Backing storage*), select `Use an existing StorageClass`. For example, `gp3-csi`.
* Click `Next`.

image::install/odf2.png[]

* Select the desired capacity and nodes.
* Click `Next`.

image::install/odf3.png[]

* Leave the default options for *Security and network* and *Review and create*. Then click `Next` and `Create StorageSystem`, respectively.

image::install/odf4.png[]

NOTE: Wait until the OpenShift Data Foundation components are fully deployed before proceeding.

[#quayoperator]
== Installing the Quay Operator

Subscribe to and deploy the `Red Hat Quay Operator`.

* Open a browser window and log in to the Red Hat OpenShift Container Platform web console.

* From the *Administrator* perspective, click `Operators`, and then select `OperatorHub`.

* In the *Filter by keyword* field, type `Red Hat Quay`.
    
image::install/operatorhub-quay.png[]

* Select the Red Hat Quay tile and click the `Install` button.

image::install/quayoperator-install.png[]

* On the *Install Operator* page, select `stable-3.15` from the list of available *Update Channel* options. Then, choose `All namespaces on the cluster (default)` as the installation mode and select `Automatic` for update approval.

image::install/quayoperator-opts.png[]

* Click `Install`.

[#quayinstance]
== Deploying Quay

* Create a new project named `quay-workshop`.

* From the *Administrator* perspective, navigate to `Operators`, and then select `Installed Operators`. Choose the `quay-workshop` project and select the Red Hat Quay Operator.

* Click `Create instance` to create a new Quay registry instance.

image::install/create-quay-instance.png[]

* If desired, change the name, and then click `Create`.

image::install/quay-create.png[]

[#exportenvvar]
== Exporting Environment Variables

IMPORTANT: It is recommended to set the `QUAY_HOSTNAME` environment variable in the working terminal before running the commands. Alternatively, you can specify the hostname directly within the commands as needed.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
QUAY_HOSTNAME=$(oc get route registry-quay -n quay-workshop -o jsonpath={.spec.host})
----

[#trustedca]
== Adding the Quay Certificate as a Trusted CA in OCP (Optional)

This step is recommended if your Quay registry uses a self-signed or internal certificate.

* Obtain the Quay registry certificate:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
echo -n | openssl s_client -showcerts -connect $QUAY_HOSTNAME:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > quay.crt
----

* Create a ConfigMap containing the CA:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc create configmap quay-ca --from-file=$QUAY_HOSTNAME=quay.crt -n openshift-config

# Verify
oc get configmap quay-ca -n openshift-config -o yaml
----

* Associate the CA with the cluster:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc patch image.config.openshift.io/cluster --type=merge -p '{"spec":{"additionalTrustedCA":{"name":"quay-ca"}}}'
----

* Verify:
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get image.config.openshift.io/cluster -o yaml
----
