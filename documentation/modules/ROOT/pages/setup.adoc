= Environment Setup
include::_attributes.adoc[]

[NOTE,subs="attributes+,+macros"]
====
This tutorial was developed and tested with:

* OpenShift `{openshift-version}`
* Quay `{quay-version}`
====

[#tools]
== Container Management Tools

The following tools are required for running the exercises in this tutorial. 
Please have them installed and configured before you get started with any of the tutorial chapters.

include::partial$tools.adoc[]

[#quay]
== Red Hat Quay Prerequisites

[#odf]
== ODF Operator

You can use the OpenShift Container Platform web console to install Quay prerequisites.

* Open a browser window and log in to the OpenShift Container Platform web console.

* From the Administrator perspective, click `Operators` → `OperatorHub`.

* In the `Filter by keyword` field, type `ODF`.

image::install/operatorhub-odf.png[]

* Select the OpenShift Data Foundation tile and click `Install`.

image::install/odf-install.png[]

* On the Install Operator page select `stable-4.10` from the list of available Update Channel options. Choose `A specific namespace on the cluster` and leave the default vaule of Installed Namespace as `openshift-storage`. Update approval `Automatic`. Console plugin `Enable`.

image::install/odfoperator-install-opts.png[]

* Click `Install`.

[#storage]
== Creating the standalone object gateway

For workshop testing purposes, and as Red Hat Quay does not support local filesystem storage, we are going to deploy the Multi-Cloud Object Gateway (MCG) component provided by the Red Hat OpenShift Data Foundation Operator which has been already installed before.

The MCG provide us a S3 compatible object storage interface for our Quay deployment managed by the Operator. The gateway use is combinated with the use of the Kubernetes `PersistenVolume` storage; which is mounted on the gateway as a backing store for object storage and any block based `StorageClass` is supported.

NOTE: This is not an HA solution.

* Create the NooBaa object storage:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cat <<EOF | oc apply -f -
apiVersion: noobaa.io/v1alpha1
kind: NooBaa
metadata:
  name: noobaa
  namespace: openshift-storage
spec:
 dbResources:
   requests:
     cpu: '0.1'
     memory: 1Gi
 dbType: postgres
 coreResources:
   requests:
     cpu: '0.1'
     memory: 1Gi
EOF
----

* After a while, check if the MCG has been provisioned:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get -n openshift-storage noobaas noobaa
----

* Configure the backing store for the gateway and make it the default for all the `ObjectBucketClaim` issued by the Operator.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cat <<EOF | oc apply -f -
apiVersion: noobaa.io/v1alpha1
kind: BackingStore
metadata:
  finalizers:
  - noobaa.io/finalizer
  labels:
    app: noobaa
  name: noobaa-pv-backing-store
  namespace: openshift-storage
spec:
  pvPool:
    numVolumes: 1
    resources:
      requests:
        storage: 50Gi
  type: pv-pool
  placementPolicy:
    tiers:
    - backingStores:
      - noobaa-pv-backing-store
EOF
----

[#quayoperator]
== Installing Quay Operator

You can use the OpenShift Container Platform web console to suscribe and deploy the `Red Hat Quay Operator`.

* Open a browser window and log in to the OpenShift Container Platform web console.

* From the Administrator perspective, click `Operators` → `OperatorHub`.

* In the Filter by keyword field, type `Red Hat Quay`.

image::install/operatorhub-quay.png[]

* Select the Red Hat Quay tile and click `Install`.

image::install/quayoperator-install.png[]

* On the Install Operator page select `stable-3.7` from the list of available Update Channel options. Choose `All namespaces on the cluster (default)` as installation mode. Choose `Automatic` update approval.

image::install/quayoperator-opts.png[]

* Click `Install`.

[#quayinstance]
== Deploying Quay

* Create a `quay-workshop` project.

* From the Administrator perspective, click `Operators` → `Installed Operators`. Project: `quay-workshop`. Select Red Hat Quay operator.

* Click on Create instance (Quay Registry).

image::install/create-quay-instance.png[]

* Change the Name if desired. Click on `Create`.

image::install/quay-create.png[]

WARNING: Check if the init container fails during the Quay registry deployment. In this case, watch out if a `LimitRange` exists in the current `OCP` project. Sometimes, the `RHPDS` environment creates a `LimitRange` automatically when a new project is created.

[#exportenvvar]
== Export environment variables

IMPORTANT: The command-line or shell will be used during the workshop. The `QUAY_HOSTNAME` environment variable has to be set in the working terminal before executing the commands. Alternatively, we can provide the hostname directly.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
QUAY_HOSTNAME=$(oc get route registry-quay -n quay-workshop -o jsonpath={.spec.host})
----
