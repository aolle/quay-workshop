= Prerequisites
include::_attributes.adoc[]

[NOTE,subs="attributes+,+macros"]
====
This tutorial was developed and tested with:

* Red Hat OpenShift `4.19.8`
* Red Hat Quay `3.15`
====

The following tools are required to run the exercises in this tutorial. Please ensure that they are installed and properly configured before proceeding with any of the tutorial chapters.

include::partial$tools.adoc[]

[#odf]
== ODF Operator

Install OpenShift Data Foundation Operator by following these steps:

* Open a browser window and log in to the Red Hat OpenShift Container Platform web console.

* From the *Administrator* perspective, click `Operators`, and then select `OperatorHub`.

* In the *Filter by keyword* field, type `ODF`.

image::install/operatorhub-odf.png[]

* Select the Red Hat OpenShift Data Foundation tile and click the `Install` button.

image::install/odf-install.png[]

* On the *Install Operator* page, select `stable-4.19` from the list of available *Update Channel* options, and then choose *A specific namespace on the cluster*. Leave the default value for *Installed Namespace* as `openshift-storage`, and set *Update Approval* to `Automatic`. Also, make sure to enable the console plug-in.

image::install/odfoperator-install-opts.png[]

* Click `Install`.

[#storage]
== Creating the ODF Cluster

Deploy an OpenShift Data Foundation (ODF) `StorageCluster` using the OpenShift web console.

* From the *Administrator* perspective in the OpenShift console, navigate to `Storage` > `Data Foundation`.
* Go to the *Storage System* tab.
* Click `Create StorageSystem`.

image::install/odf1.png[]

Select the backing storage type:

* On the first page of the wizard (*Backing storage*), select `Use an existing StorageClass`. For example, `gp3-csi`.
* Click `Next`.

image::install/odf2.png[]

* Select the desired capacity and nodes.
* Click `Next`.

image::install/odf3.png[]

* Leave the default options for *Security and network* and *Review and create*. Then click `Next` and `Create StorageSystem`, respectively.

image::install/odf4.png[]

NOTE: Wait until the OpenShift Data Foundation components are fully deployed before proceeding.

[#quayoperator]
== Installing the Quay Operator

Subscribe to and deploy the `Red Hat Quay Operator`.

* Open a browser window and log in to the Red Hat OpenShift Container Platform web console.

* From the *Administrator* perspective, click `Operators`, and then select `OperatorHub`.

* In the *Filter by keyword* field, type `Red Hat Quay`.
    
image::install/operatorhub-quay.png[]

* Select the Red Hat Quay tile and click the `Install` button.

image::install/quayoperator-install.png[]

* On the *Install Operator* page, select `stable-3.15` from the list of available *Update Channel* options. Then, choose `All namespaces on the cluster (default)` as the installation mode and select `Automatic` for update approval.

image::install/quayoperator-opts.png[]

* Click `Install`.

[#quayinstance]
== Deploying Quay

* Create a new project named `quay-workshop`.

* From the *Administrator* perspective, navigate to `Operators`, and then select `Installed Operators`. Choose the `quay-workshop` project and select the Red Hat Quay Operator.

* Click `Create instance` to create a new Quay registry instance.

image::install/create-quay-instance.png[]

* If desired, change the name, and then click `Create`.

image::install/quay-create.png[]

[#exportenvvar]
== Exporting Environment Variables

IMPORTANT: It is recommended to set the `QUAY_HOSTNAME` environment variable in the working terminal before running the commands. Alternatively, you can specify the hostname directly within the commands as needed.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
QUAY_HOSTNAME=$(oc get route registry-quay -n quay-workshop -o jsonpath={.spec.host})
----

[#trustedca]
== Adding the Quay Certificate as a Trusted CA in OCP (Optional)

This step is recommended if your Quay registry uses a self-signed or internal certificate.

* Obtain the Quay registry certificate:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
echo -n | openssl s_client -showcerts -connect $QUAY_HOSTNAME:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > quay.crt
----

* Create a ConfigMap containing the CA:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc create -n openshift-config configmap quay-ca --from-file=$QUAY_HOSTNAME=quay.crt 

# Verify
oc get -n openshift-config configmap quay-ca -o yaml
----

* Associate the CA with the cluster:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc patch image.config.openshift.io/cluster --type=merge -p '{"spec":{"additionalTrustedCA":{"name":"quay-ca"}}}'
----

* Verify:
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get image.config.openshift.io/cluster -o yaml
----

[[keycloak]]
== Installing Red Hat build of Keycloak (Optional)
// TODO: add new images

This step is **optional** and only required if you plan to configure **Quay authentication with Keycloak via OpenID Connect**.

In this section, you will deploy Red Hat build of Keycloak on OpenShift.

* Open a browser window and log in to the Red Hat OpenShift Container Platform web console.

* From the Administrator perspective, click `Operators`, then `OperatorHub`.

* In the *Filter by keyword* field, type `rhbk`.

image::install/operatorhub-rhbk.png[]

* Select the `Keycloak Operator` tile and click *Install*.

image::install/install-rhbk-operator.png[]

// update keycloak version text and images

* On the *Install Operator* page, keep the `stable-v22` option from the list of available *Update Channels*.
  The Operator only supports the installation mode *A specific namespace on the cluster*.
  Create the `rhbk` project and choose *Automatic* update approval.

image::install/rhbk-operator-opts.png[]

* Click *Install*.

Once installed, the `Keycloak Operator` will appear in the list of installed operators under *Operators* → *Installed Operators*.

image::install/rhbk-operator-installed.png[]

Keycloak requires several prerequisites (unless running in `start-dev` mode), which we will now install and configure.

We will set up a PostgreSQL database for this workshop.

* Deploy the database instance:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc -n rhbk apply -f https://raw.githubusercontent.com/aolle/quay-workshop/main/manifests/postgres.yaml
----

* Create the secrets:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc -n rhbk create secret generic keycloak-db-secret \
  --from-literal=username=keycloak \
  --from-literal=password=keycloak
----

IMPORTANT: The YAML file already includes the `keycloak` database credentials, which is acceptable for workshop purposes.  
In production, these values must be securely defined and stored in a secret.

* Create a self-signed certificate:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
openssl req -subj '/CN=<YOUR_KEYCLOAK_HOSTNAME>/O=Keycloak/C=ES' -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem

openssl req \
  -newkey rsa:2048 -nodes \
  -keyout key.pem \
  -x509 -days 365 \
  -out certificate.pem \
  -subj "/CN=<KEYCLOAK_HOSTNAME>/O=Keycloak/C=ES" \
  -addext "subjectAltName=DNS:<KEYCLOAK_HOSTNAME>"

oc create secret -n rhbk tls keycloak-tls-secret --cert=certificate.pem --key=key.pem
----

// keycloak-service-rhbk.apps.ocp.<...>

* Deploy the Red Hat build of Keycloak instance:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc -n rhbk apply -f https://raw.githubusercontent.com/aolle/quay-workshop/main/manifests/keycloak.yaml
----

After deploying and confirming that the Keycloak instance is running successfully, retrieve the automatically generated admin credentials:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc -n rhbk get secret keycloak-initial-admin -o jsonpath='{.data.username}' | base64 --decode
oc -n rhbk get secret keycloak-initial-admin -o jsonpath='{.data.password}' | base64 --decode
----

IMPORTANT: In production, always change the default credentials and enable multi-factor authentication.

* Access the administration console using the retrieved credentials.

// TODO: add new images and temp-admin

image::install/admin-console.png[]

Add the CA as a trusted certificate in Quay:

* Encode the certificate in Base64:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
base64 certificate.pem -w 0
----

* Copy the output; it will be used in the next step.

The Secret containing Quay's configuration is located in the `quay-workshop` namespace. 
Its name starts with `registry-config-bundle-` followed by a random suffix generated by the operator.

* Log in to the OpenShift web console.

* Navigate to the namespace where your QuayRegistry is deployed (e.g. `quay-workshop`):

  Operators → Installed Operators → Red Hat Quay → Quay Registries

* Click on your target QuayRegistry instance.

image::rhbk/rhbk11.png[]

* In the *Resources* tab, locate the configuration bundle Secret.
  The name typically begins with `registry-config-bundle-`.

image::rhbk/rhbk12.png[]

* Click on the Secret and select the **YAML** tab.

* Add or replace the key `extra_ca_cert_certificate_rhbk` under the `data` section:

[.lines_space]
[.console-input]c
[source,yaml]
----
kind: Secret
apiVersion: v1
metadata:
<..>
data:
  config.yaml: QUxMT1dfUFVMTFN..
  extra_ca_cert_certificate_rhbk: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0..
type: Opaque
<..>
----

image::rhbk/rhbk20.png[]

* Save the changes using the **Save** button.
